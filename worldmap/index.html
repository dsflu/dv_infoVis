<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="d3.slider.css" />
<style>
path {
  stroke: white;
  stroke-width: 0.25px;
  fill: steelblue;
}
.site {
  stroke-width: .5px;
  stroke: #333;
  fill: orangered;
}
#slider3 {
  margin: 20px 0 10px 20px;
  width: 1080px;
}
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="d3.slider.js"></script>

<div id="slider3"></div>
<script>
var width = 1080,
    height = 600;
var projection = d3.geo.mercator()
    .center([0, 0])
    .scale(200);
     // .rotate([-180,0]);
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("id","map");


var path = d3.geo.path()
    .projection(projection);
var g = svg.append("g");

var colorScale = d3.scale.linear()
                    .domain([0.0, 50.0, 200.0,1000.0])
                    .range(["#FFFF00", "#FFAA00","#FF5500", "#FF0000"]);

var radiusScale = d3.scale.linear()
                    .domain([0.0, 100.0, 200.0])
                    .range([5,15, 25]);


// load and display the World
d3.json("world-110m2.json", function(error, topology) {

g.selectAll("path")
      .data(topojson.object(topology, topology.objects.countries)
          .geometries)
    .enter()
      .append("path")
      .attr("d", path)

d3.csv("dv_data.csv")
    .row(function(d) {
      return {
        case: d.case,
        time: d.time,
        lat: d.latitude,
        lng: d.longitude,
        nkill: d.nkill,
        city: d.city,
        time: d.time,
        //created_at: moment(d.time,"DD-MM-YYYY hh:mm:ss").unix()
        year: d.iyear,
        year_m: d.year_m,
        level: d.level
      };
    })
    .get(function(err, rows) {
      if (err) return console.error(err);

      window.site_data = rows;
    });

});

var tooltip = d3.select("body")
    .append("div")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .text("")

var displaySites = function(data) {
  var sites = svg.selectAll(".site")
      .data(data, function(d) {
        return d.case;
      });
  sites.enter()
      .append("a")
          .attr("xlink:href", function(d) {
            return "https://www.google.com/search?q="+d.city+" "+d.time;}
          )
      .append("circle")
      .attr("class", "site")
      .on("mouseover", function(d){return tooltip.text("year:"+d.time+",city:"+d.city+", nkill:"+d.nkill).style("visibility", "visible").style("background-color","white");})
       .on("mousemove", function(){return tooltip.style("top", 
    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
       .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
      .attr("cx", function(d) {
        return projection([d.lng, d.lat])[0];
      })
      .attr("cy", function(d) {
        return projection([d.lng, d.lat])[1];
      })
      .attr("r", 0.1)
      .style("fill",  "black")
      .transition().duration(400)
        .attr("r", function(d){return radiusScale(d.level);})
        .style("fill",  "red")
        .transition().duration(800)
        .attr("r", 3)
        .style("fill",  function(d){return colorScale(d.level);});
  sites.exit()
    .transition().duration(200)
      .attr("r",0.1)
      .remove();
};

var minDateUnix = 1992;
var maxDateUnix = 2015;

// var secondsInDay = 60 * 60 * 24;
d3.select('#slider3').call(d3.slider()
  .axis(true).min(minDateUnix).max(maxDateUnix).step(0.1)
  .on("slide", function(evt, value) {
    var newData = _(site_data).filter( function(site) {
      //console.log();
      return site.year_m < value ;
    })
    displaySites(newData);
  })
);

// zoom and pan
// var zoom = d3.behavior.zoom()
//     .on("zoom",function() {
//         g.attr("transform","translate("+ 
//             d3.event.translate.join(",")+")scale("+d3.event.scale+")");
//         g.selectAll("path")  
//             .attr("d", path.projection(projection)); 
//   });
// svg.call(zoom)


</script>


</body>